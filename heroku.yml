setup:
  addons:
    - plan: heroku-redis
      as: REDIS
    # Add postgresql addon definition (or ensure it's already here)
    - plan: heroku-postgresql
      as: DATABASE # Use DATABASE to align with DATABASE_URL

build:
  docker:
    release:
      dockerfile: Dockerfile # Assuming release uses the main Dockerfile
    # Consolidated web dyno using Nginx + Gunicorn
    web: Dockerfile
    # api process removed
    worker: Dockerfile.worker

# NEW: Release phase to run migrations
release:
  command:
    - flask --app backend.app:app db upgrade
  image: release

run:
  # Run the consolidated start script for web
  web: /app/start.sh
  # api process removed
  worker:
    command:
      - celery -A backend.celery_app:celery worker --loglevel=info
    image: worker
