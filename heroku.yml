setup:
  addons:
    - plan: heroku-redis
      as: REDIS

build:
  docker:
    # Consolidated web dyno using Nginx + Gunicorn
    web:
      dockerfile: docker/web.Dockerfile
      context: . # Explicitly set build context to project root
    # api process removed
    worker: backend/Dockerfile

run:
  # Reverting to separate processes
  web: sh -c "envsubst '\$PORT' < /etc/nginx/conf.d/default.conf > /tmp/nginx.conf && nginx -c /tmp/nginx.conf -g 'daemon off;'"
  api: gunicorn backend.app:app --bind 0.0.0.0:$PORT --timeout 120 -k gevent --log-level debug --access-logfile - --error-logfile -
  worker: celery -A backend.celery_app:celery worker --loglevel=info
